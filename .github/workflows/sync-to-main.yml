name: Sync to LAD Main Repositories

on:
  push:
    branches: [main]
  workflow_dispatch:

# âš ï¸ IMPORTANT: This workflow ONLY syncs campaign-specific files:
#   âœ… Backend: /backend/features/campaigns/
#   âœ… Frontend: /frontend/sdk/features/campaigns/ and /frontend/components/campaigns/
#   âŒ Blocked: /backend/core/, /backend/config/, /backend/shared/, /backend/feature_flags/
#   âŒ Blocked: Any non-campaign backend directories

jobs:
  validate-paths:
    runs-on: ubuntu-latest
    name: Validate campaign-only sync
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 10
      
      - name: Check commit contains only campaign files
        run: |
          echo "ğŸ” SECURITY CHECK: Validating commit paths..."
          echo ""
          
          # Get changed files from last commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          
          echo "ğŸ“‹ Files in this commit:"
          echo "$CHANGED_FILES" | sed 's/^/   /'
          echo ""
          
          # Check for forbidden directories
          FORBIDDEN_PATTERNS=(
            '^backend/core/'
            '^backend/config/'
            '^backend/shared/'
            '^backend/feature_flags/'
            '^backend/migrations/'
            '^backend/scripts/'
          )
          
          HAS_FORBIDDEN=0
          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            if echo "$CHANGED_FILES" | grep -E "$pattern" > /dev/null; then
              echo "âŒ BLOCKED: Found files in forbidden directory:"
              echo "$CHANGED_FILES" | grep -E "$pattern" | sed 's/^/   âŒ /'
              HAS_FORBIDDEN=1
            fi
          done
          
          if [ $HAS_FORBIDDEN -eq 1 ]; then
            echo ""
            echo "âŒ VALIDATION FAILED"
            echo "   Only these paths are allowed:"
            echo "   âœ… backend/features/campaigns/"
            echo "   âœ… frontend/"
            exit 1
          fi
          
          # Check that at least some campaign files are committed
          if echo "$CHANGED_FILES" | grep -E '(backend/features/campaigns/|frontend/)' > /dev/null; then
            echo "âœ… VALIDATION PASSED"
            echo "   All files are from allowed campaign paths"
          else
            echo "âš ï¸  WARNING: No campaign files detected in commit"
            echo "   (This might be OK if only updating docs or configs)"
          fi

  sync-backend:
    needs: [validate-paths]
    runs-on: ubuntu-latest
    # Only run on main branch
    if: github.ref == 'refs/heads/main' && success()
    steps:
      - name: Checkout feature repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Checkout LAD-Backend
        uses: actions/checkout@v3
        with:
          repository: techiemaya-admin/LAD-Backend
          token: ${{ secrets.LAD_REPO_TOKEN }}
          path: lad-backend
          ref: develop

      - name: Copy backend files
        run: |
          echo "ğŸ“¦ Starting backend file sync..."
          
          # CRITICAL: Verify source exists
          if [ ! -d "backend/features/campaigns" ]; then
            echo "âŒ Source directory not found: backend/features/campaigns"
            exit 1
          fi
          
          # SAFETY CHECK: Verify no core, config, shared files are in the commit
          echo "ğŸ”’ Verifying no non-campaign files are included..."
          if git diff --name-only HEAD~1 HEAD | grep -E '^backend/(core|config|shared)/' > /dev/null; then
            echo "âŒ BLOCKED: Found non-campaign files in commit (core/config/shared)"
            echo "   Only backend/features/campaigns/ and frontend/ should be committed"
            git diff --name-only HEAD~1 HEAD | grep -E '^backend/(core|config|shared)/' | sed 's/^/   âŒ /'
            exit 1
          fi
          
          # Ensure destination exists
          mkdir -p lad-backend/features/campaigns
          
          # Sync ONLY campaign files with strict exclusions
          if ! rsync -av \
            --filter='+ /manifest.js' \
            --filter='+ /index.js' \
            --filter='+ /package.json' \
            --filter='+ *.js' \
            --filter='+ *.json' \
            --filter='+ *.sql' \
            --filter='+ *.ts' \
            --filter='+ *.tsx' \
            --filter='+ *.md' \
            --filter='+ *.yml' \
            --filter='+ *.yaml' \
            --filter='- /.*' \
            --exclude='.env*' \
            --exclude='*.local.js' \
            --exclude='*.test.js' \
            --exclude='*.test.ts' \
            --exclude='*.spec.js' \
            --exclude='*.spec.ts' \
            --exclude='node_modules' \
            --exclude='.DS_Store' \
            --exclude='.git*' \
            --exclude='coverage' \
            --exclude='dist' \
            --exclude='build' \
            backend/features/campaigns/ lad-backend/features/campaigns/; then
            echo "âŒ rsync failed!"
            exit 1
          fi
          
          echo "âœ… Backend files synced successfully"
          echo "ğŸ“‹ Synced files:"
          find lad-backend/features/campaigns -type f | wc -l | xargs echo "   Total files:"

      - name: Verify critical files
        run: |
          echo "ğŸ” Verifying critical files..."
          MISSING=0
          
          # Check for essential files
          CRITICAL_FILES=(
            "lad-backend/features/campaigns/manifest.js"
            "lad-backend/features/campaigns/index.js"
            "lad-backend/features/campaigns/routes/index.js"
            "lad-backend/features/campaigns/constants.js"
          )
          
          for file in "${CRITICAL_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ CRITICAL: $file is missing!"
              MISSING=1
            else
              echo "âœ… $file exists"
            fi
          done
          
          if [ $MISSING -eq 1 ]; then
            echo "âŒ Sync validation failed - critical files missing"
            exit 1
          fi
          
          echo "âœ… All critical files verified"

      - name: Commit and push to LAD-Backend
        working-directory: lad-backend
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Clean up any unstaged changes outside features/campaigns
          echo "ğŸ§¹ Cleaning working directory..."
          git status
          
          # Stash any uncommitted changes first
          if ! git diff --quiet || ! git diff --staged --quiet; then
            echo "âš ï¸ Found uncommitted changes, stashing..."
            git stash
          fi
          
          # Pull latest changes to avoid conflicts
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin develop --rebase || {
            echo "âš ï¸ Rebase conflict detected"
            git rebase --abort
            git stash pop || true
            exit 1
          }
          
          # Restore any stashed changes
          if git stash list | grep -q .; then
            echo "ğŸ“¥ Restoring stashed changes..."
            git stash pop || true
          fi
          
          # Stage ONLY campaign changes
          git add features/campaigns/
          
          # SAFETY: Verify only campaign files are staged
          echo "ğŸ” Verifying staged files..."
          if git diff --staged --name-only | grep -v '^features/campaigns/' > /dev/null; then
            echo "âŒ BLOCKED: Found non-campaign files in staging area!"
            git diff --staged --name-only | grep -v '^features/campaigns/' | sed 's/^/   âŒ /'
            git reset
            exit 1
          fi
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
            exit 0
          fi
          
          # Show what changed
          echo "ğŸ“ Changes to be committed:"
          git diff --staged --stat
          echo ""
          echo "ğŸ“‹ Staging validation:"
          echo "   âœ… All staged files are from features/campaigns/"
          
          # Commit
          git commit -m "feat(campaigns): auto-sync from feature repo" \
            -m "Synced from: ${{ github.repository }}@${{ github.sha }}" \
            -m "Triggered by: ${{ github.actor }}" \
            -m "Timestamp: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" \
            -m "Workflow: ${{ github.workflow }}"
          
          # Push with retry logic
          echo "ğŸ“¤ Pushing to LAD-Backend..."
          for attempt in {1..3}; do
            if git push origin develop; then
              echo "âœ… Push successful on attempt $attempt"
              exit 0
            fi
            
            echo "âš ï¸ Push failed, retrying ($attempt/3)..."
            sleep 2
            git pull origin develop --rebase || {
              echo "âŒ Rebase failed on retry"
              git rebase --abort
              exit 1
            }
          done
          
          echo "âŒ Failed to push after 3 attempts"
          exit 1

  sync-frontend:
    needs: [validate-paths]
    runs-on: ubuntu-latest
    # Only run on main branch
    if: github.ref == 'refs/heads/main' && success()
    steps:
      - name: Checkout feature repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Checkout LAD-Frontend
        uses: actions/checkout@v3
        with:
          repository: techiemaya-admin/LAD-Frontend
          token: ${{ secrets.LAD_REPO_TOKEN }}
          path: lad-frontend
          ref: develop

      - name: Copy frontend SDK files
        run: |
          echo "ğŸ“¦ Starting frontend SDK sync..."
          
          # SAFETY CHECK: Verify no core, shared, config files are in the commit
          echo "ğŸ”’ Verifying no non-campaign files are included..."
          if git diff --name-only HEAD~1 HEAD | grep -E '^backend/(core|config|shared)/' > /dev/null; then
            echo "âŒ BLOCKED: Found non-campaign files in commit (core/config/shared)"
            echo "   Only backend/features/campaigns/ and frontend/ should be committed"
            exit 1
          fi
          
          # Check if SDK directory exists
          if [ ! -d "frontend/sdk/features/campaigns" ]; then
            echo "âš ï¸ No frontend SDK directory found, skipping"
            echo "HAS_SDK=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "HAS_SDK=true" >> $GITHUB_ENV
          
          # Ensure directory exists
          mkdir -p lad-frontend/sdk/features/campaigns

          # Sync ONLY SDK campaign files with strict exclusions
          if ! rsync -av \
            --filter='+ *.ts' \
            --filter='+ *.tsx' \
            --filter='+ *.js' \
            --filter='+ *.json' \
            --filter='+ *.md' \
            --filter='- *.test.ts' \
            --filter='- *.test.tsx' \
            --filter='- *.spec.ts' \
            --filter='- *.spec.tsx' \
            --exclude='node_modules' \
            --exclude='.DS_Store' \
            --exclude='.git*' \
            --exclude='dist' \
            --exclude='build' \
            --exclude='coverage' \
            frontend/sdk/features/campaigns/ lad-frontend/sdk/features/campaigns/; then
            echo "âŒ SDK sync failed!"
            exit 1
          fi
          
          echo "âœ… Frontend SDK files synced successfully"

          # Copy components if they exist (optional, campaigns-only)
          if [ -d "frontend/components/campaigns" ] && [ "$(ls -A frontend/components/campaigns 2>/dev/null)" ]; then
            echo "ğŸ“¦ Syncing campaign components..."
            mkdir -p lad-frontend/web/src/features/campaigns
            rsync -av \
              --filter='+ *.tsx' \
              --filter='+ *.ts' \
              --filter='+ *.css' \
              --filter='+ *.scss' \
              --filter='+ *.md' \
              --filter='- *.test.*' \
              --filter='- *.spec.*' \
              --exclude='node_modules' \
              --exclude='.DS_Store' \
              frontend/components/campaigns/ lad-frontend/web/src/features/campaigns/
            echo "HAS_COMPONENTS=true" >> $GITHUB_ENV
          else
            echo "â„¹ï¸ No campaign components to sync"
            echo "HAS_COMPONENTS=false" >> $GITHUB_ENV
          fi
          
          echo "âœ… Frontend files synced successfully"

      - name: Verify frontend files
        if: env.HAS_SDK == 'true'
        run: |
          echo "ğŸ” Verifying frontend SDK files..."
          
          # Check for essential SDK files
          CRITICAL_FILES=(
            "lad-frontend/sdk/features/campaigns/index.ts"
            "lad-frontend/sdk/features/campaigns/api.ts"
            "lad-frontend/sdk/features/campaigns/types.ts"
          )
          
          MISSING=0
          for file in "${CRITICAL_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ CRITICAL: $file is missing!"
              MISSING=1
            else
              echo "âœ… $file exists"
            fi
          done
          
          if [ $MISSING -eq 1 ]; then
            echo "âŒ Frontend sync validation failed"
            exit 1
          fi
          
          echo "âœ… Frontend SDK verified"

      - name: Commit and push to LAD-Frontend
        if: env.HAS_SDK == 'true'
        working-directory: lad-frontend
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Clean up any unstaged changes
          echo "ğŸ§¹ Cleaning working directory..."
          git status
          
          # Stash any uncommitted changes first
          if ! git diff --quiet || ! git diff --staged --quiet; then
            echo "âš ï¸ Found uncommitted changes, stashing..."
            git stash
          fi
          
          # Pull latest
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin develop --rebase || {
            echo "âš ï¸ Rebase conflict detected"
            git rebase --abort
            git stash pop || true
            exit 1
          }
          
          # Restore any stashed changes
          if git stash list | grep -q .; then
            echo "ğŸ“¥ Restoring stashed changes..."
            git stash pop || true
          fi
          
          # Stage ONLY campaign SDK changes
          git add sdk/features/campaigns/
          if [ "${{ env.HAS_COMPONENTS }}" = "true" ]; then
            git add web/src/features/campaigns/
          fi
          
          # SAFETY: Verify only campaign files are staged
          echo "ğŸ” Verifying staged files..."
          if git diff --staged --name-only | grep -v '^sdk/features/campaigns/' | grep -v '^web/src/features/campaigns/' > /dev/null; then
            echo "âŒ BLOCKED: Found non-campaign files in staging area!"
            git diff --staged --name-only | grep -v '^sdk/features/campaigns/' | grep -v '^web/src/features/campaigns/' | sed 's/^/   âŒ /'
            git reset
            exit 1
          fi
          
          # Check for changes
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
            exit 0
          fi
          
          # Show changes
          echo "ğŸ“ Changes to be committed:"
          git diff --staged --stat
          echo ""
          echo "ğŸ“‹ Staging validation:"
          echo "   âœ… All staged files are from SDK or campaign components"
          
          # Commit
          git commit -m "feat(campaigns): auto-sync SDK from feature repo" \
            -m "Synced from: ${{ github.repository }}@${{ github.sha }}" \
            -m "Triggered by: ${{ github.actor }}" \
            -m "Timestamp: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" \
            -m "Workflow: ${{ github.workflow }}"
          
          # Push with retry
          echo "ğŸ“¤ Pushing to LAD-Frontend..."
          for attempt in {1..3}; do
            if git push origin develop; then
              echo "âœ… Push successful on attempt $attempt"
              exit 0
            fi
            
            echo "âš ï¸ Push failed, retrying ($attempt/3)..."
            sleep 2
            git pull origin develop --rebase || {
              echo "âŒ Rebase failed on retry"
              git rebase --abort
              exit 1
            }
          done
          
          echo "âŒ Failed to push after 3 attempts"
          exit 1

  notify-success:
    needs: [validate-paths, sync-backend, sync-frontend]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Success notification
        run: |
          echo "âœ… Campaign sync completed successfully"
          echo ""
          echo "ğŸ” Security: Path validation passed"
          echo "ğŸ“¤ Backend: Synced to LAD-Backend/feature/campaigns"
          echo "ğŸ“¤ Frontend: Synced to LAD-Frontend/sdk/features/campaigns"

  notify-failure:
    needs: [validate-paths, sync-backend, sync-frontend]
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Failure notification
        run: |
          echo "âŒ Campaign sync failed"
          echo ""
          if [ "${{ needs.validate-paths.result }}" = "failure" ]; then
            echo "ğŸ” PATH VALIDATION FAILED"
            echo "   Reason: Non-campaign files detected in commit"
            echo "   Only these paths are allowed:"
            echo "   â€¢ backend/features/campaigns/"
            echo "   â€¢ frontend/sdk/features/campaigns/"
            echo "   â€¢ frontend/components/campaigns/"
          else
            echo "See workflow logs for sync errors"
          fi
          exit 1
